"use strict";
/*!
 *  omix v2.0.0 by dntzhang
 *  Github: https://github.com/Tencent/omi
 *  MIT Licensed.
*/
Object.defineProperty(exports, "__esModule", { value: true });
var obaa_1 = require("./obaa");
var path_1 = require("./path");
var ARRAYTYPE = '[object Array]';
var OBJECTTYPE = '[object Object]';
var FUNCTIONTYPE = '[object Function]';
function create(store, option) {
    if (arguments.length === 2) {
        if (!store.instances) {
            store.instances = {};
        }
        getApp().globalData && (getApp().globalData.store = store);
        option.data = store.data;
        observeStore(store);
        var onLoad_1 = option.onLoad;
        option.onLoad = function (e) {
            this.store = store;
            option.use && (this.__updatePath = path_1.getPath(option.use));
            this.__use = option.use;
            store.instances[this.route] = [];
            store.instances[this.route].push(this);
            if (!option.data.___walked) {
                walk(this.store.data);
            }
            this.setData(option.data);
            var using = path_1.getUsing(store.data, option.use);
            using && this.setData(using);
            onLoad_1 && onLoad_1.call(this, e);
        };
        Page(option);
    }
    else {
        var ready_1 = (store.lifetimes && store.lifetimes.ready) || store.ready;
        store.lifetimes = store.lifetimes || {};
        store.ready = store.lifetimes.ready = function () {
            var page = getCurrentPages()[getCurrentPages().length - 1];
            store.use && (this.__updatePath = path_1.getPath(store.use));
            this.store = page.store;
            this.__use = store.use;
            store.data = this.store.data;
            this.setData(store.data);
            var using = path_1.getUsing(this.store.data, store.use);
            using && this.setData(using);
            this.store.instances[page.route].push(this);
            ready_1 && ready_1.call(this);
        };
        Component(store);
    }
}
function observeStore(store) {
    obaa_1.default(store.data, function (prop, value, old, path) {
        var patch = {};
        if (prop.indexOf('Array-push') === 0) {
            var dl = value.length - old.length;
            for (var i = 0; i < dl; i++) {
                patch[path_1.fixPath(path + '-' + (old.length + i))] = value[(old.length + i)];
            }
        }
        else if (prop.indexOf('Array-') === 0) {
            patch[path_1.fixPath(path)] = value;
        }
        else {
            patch[path_1.fixPath(path + '-' + prop)] = value;
        }
        _update(patch, store);
    });
}
function _update(kv, store) {
    for (var key in store.instances) {
        store.instances[key].forEach(function (ins) {
            if (store.updateAll || ins.__updatePath && path_1.needUpdate(kv, ins.__updatePath)) {
                ins.setData.call(ins, kv);
                var using = path_1.getUsing(store.data, ins.__use);
                using && ins.setData(using);
                updateStoreByFnProp(ins, store.data);
            }
        });
    }
    store.onChange && store.onChange(kv);
    store.debug && storeChangeLogger(store);
}
function storeChangeLogger(store) {
    store.onChange = function (diffResult) {
        try {
            var preState = wx.getStorageSync("CurrentState") || {};
            var title = "State Changed";
            console.groupCollapsed("%c  " + title + " %c " + Object.keys(diffResult), 'color:#e0c184; font-weight: bold', 'color:#f0a139; font-weight: bold');
            console.log("%c    Pre State", 'color:#ff65af; font-weight: bold', preState);
            console.log("%c Change State", 'color:#3d91cf; font-weight: bold', diffResult);
            console.log("%c   Next State", 'color:#2c9f67; font-weight: bold', store.data);
            console.groupEnd();
            wx.setStorageSync("CurrentState", store.data);
        }
        catch (e) {
            console.log(e);
        }
    };
}
function updateStoreByFnProp(ele, data) {
    if (data) {
        var patch = {};
        for (var key in data.__fnMapping) {
            patch[key] = data.__fnMapping[key].call(data);
        }
        ele.setData(patch);
    }
}
function getObjByPath(path, data) {
    var arr = path.replace(/]/g, '').replace(/\[/g, '.').split('.');
    var len = arr.length;
    if (len > 1) {
        var current = data[arr[0]];
        for (var i = 1; i < len - 1; i++) {
            current = current[arr[i]];
        }
        return { obj: current, key: arr[len - 1] };
    }
    else {
        return { obj: data, key: arr[0] };
    }
}
function walk(data) {
    data.___walked = true;
    Object.keys(data).forEach(function (key) {
        var obj = data[key];
        var tp = type(obj);
        if (tp == FUNCTIONTYPE) {
            setProp(key, obj, data);
        }
        else if (tp == OBJECTTYPE) {
            Object.keys(obj).forEach(function (subKey) {
                _walk(obj[subKey], key + '.' + subKey, data);
            });
        }
        else if (tp == ARRAYTYPE) {
            obj.forEach(function (item, index) {
                _walk(item, key + '[' + index + ']', data);
            });
        }
    });
}
function _walk(obj, path, data) {
    var tp = type(obj);
    if (tp == FUNCTIONTYPE) {
        setProp(path, obj, data);
    }
    else if (tp == OBJECTTYPE) {
        Object.keys(obj).forEach(function (subKey) {
            _walk(obj[subKey], path + '.' + subKey, data);
        });
    }
    else if (tp == ARRAYTYPE) {
        obj.forEach(function (item, index) {
            _walk(item, path + '[' + index + ']', data);
        });
    }
}
function setProp(path, fn, data) {
    var ok = getObjByPath(path, data);
    data.__fnMapping = data.__fnMapping || {};
    data.__fnMapping[path] = fn;
    Object.defineProperty(ok.obj, ok.key, {
        enumerable: true,
        get: function () {
            return fn.call(ok.obj);
        },
        set: function () {
            console.warn('Please using this.data.method to set method prop of data!');
        }
    });
}
function type(obj) {
    return Object.prototype.toString.call(obj);
}
function updateByFnProp(ele, data) {
    var patch = {};
    for (var key in data.__fnMapping) {
        patch[key] = data.__fnMapping[key].call(ele.oData);
    }
    ele.setData(patch);
}
create.obaa = obaa_1.default;
exports.default = create;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiY3JlYXRlLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiY3JlYXRlLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7QUFBQTs7OztFQUlFOztBQUVGLCtCQUF5QjtBQUN6QiwrQkFBK0Q7QUFFL0QsSUFBTSxTQUFTLEdBQUcsZ0JBQWdCLENBQUE7QUFDbEMsSUFBTSxVQUFVLEdBQUcsaUJBQWlCLENBQUE7QUFDcEMsSUFBTSxZQUFZLEdBQUcsbUJBQW1CLENBQUE7QUFHeEMsU0FBUyxNQUFNLENBQUMsS0FBSyxFQUFFLE1BQU07SUFDM0IsSUFBSSxTQUFTLENBQUMsTUFBTSxLQUFLLENBQUMsRUFBRTtRQUMxQixJQUFJLENBQUMsS0FBSyxDQUFDLFNBQVMsRUFBRTtZQUNwQixLQUFLLENBQUMsU0FBUyxHQUFHLEVBQUUsQ0FBQTtTQUNyQjtRQUVELE1BQU0sRUFBRSxDQUFDLFVBQVUsSUFBSSxDQUFDLE1BQU0sRUFBRSxDQUFDLFVBQVUsQ0FBQyxLQUFLLEdBQUcsS0FBSyxDQUFDLENBQUE7UUFFMUQsTUFBTSxDQUFDLElBQUksR0FBRyxLQUFLLENBQUMsSUFBSSxDQUFBO1FBQ3hCLFlBQVksQ0FBQyxLQUFLLENBQUMsQ0FBQTtRQUNuQixJQUFNLFFBQU0sR0FBRyxNQUFNLENBQUMsTUFBTSxDQUFBO1FBRTVCLE1BQU0sQ0FBQyxNQUFNLEdBQUcsVUFBVSxDQUFDO1lBQ3pCLElBQUksQ0FBQyxLQUFLLEdBQUcsS0FBSyxDQUFBO1lBRWxCLE1BQU0sQ0FBQyxHQUFHLElBQUksQ0FBQyxJQUFJLENBQUMsWUFBWSxHQUFHLGNBQU8sQ0FBQyxNQUFNLENBQUMsR0FBRyxDQUFDLENBQUMsQ0FBQTtZQUN2RCxJQUFJLENBQUMsS0FBSyxHQUFHLE1BQU0sQ0FBQyxHQUFHLENBQUE7WUFDdkIsS0FBSyxDQUFDLFNBQVMsQ0FBQyxJQUFJLENBQUMsS0FBSyxDQUFDLEdBQUcsRUFBRSxDQUFBO1lBQ2hDLEtBQUssQ0FBQyxTQUFTLENBQUMsSUFBSSxDQUFDLEtB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UUFDaEMsS0FBSyxDQUFDLEdBQUcsQ0FBQyxHQUFHLElBQUksQ0FBQyxXQUFXLENBQUMsR0FBRyxDQUFDLENBQUMsSUFBSSxDQUFDLEdBQUcsQ0FBQyxLQUFLLENBQUMsQ0FBQTtLQUNuRDtJQUNELEdBQUcsQ0FBQyxPQUFPLENBQUMsS0FBSyxDQUFDLENBQUE7QUFDcEIsQ0FBQztBQUdELE1BQU0sQ0FBQyxJQUFJLEdBQUcsY0FBSSxDQUFBO0FBR2xCLGtCQUFlLE1BQU0sQ0FBQSIsInNvdXJjZXNDb250ZW50IjpbIi8qIVxuICogIG9taXggdjIuMC4wIGJ5IGRudHpoYW5nXG4gKiAgR2l0aHViOiBodHRwczovL2dpdGh1Yi5jb20vVGVuY2VudC9vbWlcbiAqICBNSVQgTGljZW5zZWQuXG4qL1xuXG5pbXBvcnQgb2JhYSBmcm9tICcuL29iYWEnXG5pbXBvcnQgeyBnZXRQYXRoLCBuZWVkVXBkYXRlLCBmaXhQYXRoLCBnZXRVc2luZyB9IGZyb20gJy4vcGF0aCdcblxuY29uc3QgQVJSQVlUWVBFID0gJ1tvYmplY3QgQXJyYXldJ1xuY29uc3QgT0JKRUNUVFlQRSA9ICdbb2JqZWN0IE9iamVjdF0nXG5jb25zdCBGVU5DVElPTlRZUEUgPSAnW29iamVjdCBGdW5jdGlvbl0nXG5cblxuZnVuY3Rpb24gY3JlYXRlKHN0b3JlLCBvcHRpb24pIHtcbiAgaWYgKGFyZ3VtZW50cy5sZW5ndGggPT09IDIpIHtcbiAgICBpZiAoIXN0b3JlLmluc3RhbmNlcykge1xuICAgICAgc3RvcmUuaW5zdGFuY2VzID0ge31cbiAgICB9XG5cbiAgICBnZXRBcHAoKS5nbG9iYWxEYXRhICYmIChnZXRBcHAoKS5nbG9iYWxEYXRhLnN0b3JlID0gc3RvcmUpXG4gICBcbiAgICBvcHRpb24uZGF0YSA9IHN0b3JlLmRhdGFcbiAgICBvYnNlcnZlU3RvcmUoc3RvcmUpXG4gICAgY29uc3Qgb25Mb2FkID0gb3B0aW9uLm9uTG9hZFxuXG4gICAgb3B0aW9uLm9uTG9hZCA9IGZ1bmN0aW9uIChlKSB7XG4gICAgICB0aGlzLnN0b3JlID0gc3RvcmVcblxuICAgICAgb3B0aW9uLnVzZSAmJiAodGhpcy5fX3VwZGF0ZVBhdGggPSBnZXRQYXRoKG9wdGlvbi51c2UpKVxuICAgICAgdGhpcy5fX3VzZSA9IG9wdGlvbi51c2VcbiAgICAgIHN0b3JlLmluc3RhbmNlc1t0aGlzLnJvdXRlXSA9IFtdXG4gICAgICBzdG9yZS5pbnN0YW5jZXNbdGhpcy5yb3V0ZV0ucHVzaCh0aGlzKVxuICAgICAgaWYgKCFvcHRpb24uZGF0YS5fX193YWxrZWQpIHtcbiAgICAgICAgd2Fsayh0aGlzLnN0b3JlLmRhdGEpXG4gICAgICB9XG4gICAgICB0aGlzLnNldERhdGEob3B0aW9uLmRhdGEpXG4gICAgICBjb25zdCB1c2luZyA9IGdldFVzaW5nKHN0b3JlLmRhdGEsIG9wdGlvbi51c2UpXG4gICAgICB1c2luZyAmJiB0aGlzLnNldERhdGEodXNpbmcpXG4gICAgICBvbkxvYWQgJiYgb25Mb2FkLmNhbGwodGhpcywgZSlcbiAgICB9XG4gICAgUGFnZShvcHRpb24pXG4gIH0gZWxzZSB7XG4gICAgY29uc3QgcmVhZHkgPSAoc3RvcmUubGlmZXRpbWVzICYmIHN0b3JlLmxpZmV0aW1lcy5yZWFkeSkgfHwgc3RvcmUucmVhZHlcbiAgICBzdG9yZS5saWZldGltZXMgPSBzdG9yZS5saWZldGltZXMgfHwge31cbiAgICBzdG9yZS5yZWFkeSA9IHN0b3JlLmxpZmV0aW1lcy5yZWFkeSA9IGZ1bmN0aW9uICgpIHtcbiAgICAgIGNvbnN0IHBhZ2UgPSBnZXRDdXJyZW50UGFnZXMoKVtnZXRDdXJyZW50UGFnZXMoKS5sZW5ndGggLSAxXVxuICAgICAgc3RvcmUudXNlICYmICh0aGlzLl9fdXBkYXRlUGF0aCA9IGdldFBhdGgoc3RvcmUudXNlKSlcbiAgICAgIHRoaXMuc3RvcmUgPSBwYWdlLnN0b3JlXG4gICAgICB0aGlzLl9fdXNlID0gc3RvcmUudXNlXG4gICAgICBzdG9yZS5kYXRhID0gdGhpcy5zdG9yZS5kYXRhXG4gICAgICB0aGlzLnNldERhdGEoc3RvcmUuZGF0YSlcbiAgICAgIGNvbnN0IHVzaW5nID0gZ2V0VXNpbmcodGhpcy5zdG9yZS5kYXRhLCBzdG9yZS51c2UpXG4gICAgICB1c2luZyAmJiB0aGlzLnNldERhdGEodXNpbmcpXG4gICAgICB0aGlzLnN0b3JlLmluc3RhbmNlc1twYWdlLnJvdXRlXS5wdXNoKHRoaXMpXG4gICAgICByZWFkeSAmJiByZWFkeS5jYWxsKHRoaXMpXG4gICAgfVxuICAgIENvbXBvbmVudChzdG9yZSlcbiAgfVxufVxuXG5cbmZ1bmN0aW9uIG9ic2VydmVTdG9yZShzdG9yZSkge1xuICBvYmFhKHN0b3JlLmRhdGEsIChwcm9wLCB2YWx1ZSwgb2xkLCBwYXRoKSA9PiB7XG4gICAgbGV0IHBhdGNoID0ge31cbiAgICBpZiAocHJvcC5pbmRleE9mKCdBcnJheS1wdXNoJykgPT09IDApIHtcbiAgICAgIGxldCBkbCA9IHZhbHVlLmxlbmd0aCAtIG9sZC5sZW5ndGhcbiAgICAgIGZvciAobGV0IGkgPSAwOyBpIDwgZGw7IGkrKykge1xuICAgICAgICBwYXRjaFsgZml4UGF0aChwYXRoICsgJy0nICsgKG9sZC5sZW5ndGggKyBpKSldID0gdmFsdWVbKG9sZC5sZW5ndGggKyBpKV1cbiAgICAgIH1cbiAgICB9IGVsc2UgaWYgKHByb3AuaW5kZXhPZignQXJyYXktJykgPT09IDApIHtcbiAgICAgIHBhdGNoWyBmaXhQYXRoKHBhdGgpXSA9IHZhbHVlXG4gICAgfSBlbHNlIHtcbiAgICAgIHBhdGNoWyBmaXhQYXRoKHBhdGggKyAnLScgKyBwcm9wKV0gPSB2YWx1ZVxuICAgIH1cblxuICAgIF91cGRhdGUocGF0Y2gsIHN0b3JlKVxuICAgIFxuICAgIFxuICB9KVxufVxuXG5mdW5jdGlvbiBfdXBkYXRlKGt2LCBzdG9yZSkge1xuICBmb3IgKGxldCBrZXkgaW4gc3RvcmUuaW5zdGFuY2VzKSB7XG4gICAgc3RvcmUuaW5zdGFuY2VzW2tleV0uZm9yRWFjaChpbnMgPT4ge1xuICAgICAgaWYoc3RvcmUudXBkYXRlQWxsIHx8IGlucy5fX3VwZGF0ZVBhdGggJiYgbmVlZFVwZGF0ZShrdixpbnMuX191cGRhdGVQYXRoKSl7XG4gICAgICAgIGlucy5zZXREYXRhLmNhbGwoaW5zLCBrdilcblxuICAgICAgICBjb25zdCB1c2luZyA9IGdldFVzaW5nKHN0b3JlLmRhdGEsIGlucy5fX3VzZSlcbiAgICAgICAgdXNpbmcgJiYgaW5zLnNldERhdGEodXNpbmcpXG5cbiAgICAgICAgLy/ljbPlsIblup/lvINcbiAgICAgICAgdXBkYXRlU3RvcmVCeUZuUHJvcChpbnMsIHN0b3JlLmRhdGEpXG4gICAgICB9XG4gICAgfSlcbiAgfVxuICBzdG9yZS5vbkNoYW5nZSAmJiBzdG9yZS5vbkNoYW5nZShrdilcbiAgc3RvcmUuZGVidWcgJiYgc3RvcmVDaGFuZ2VMb2dnZXIoc3RvcmUpXG59XG5cbmZ1bmN0aW9uIHN0b3JlQ2hhbmdlTG9nZ2VyIChzdG9yZSkge1xuICAgIHN0b3JlLm9uQ2hhbmdlID0gKGRpZmZSZXN1bHQpID0+IHtcbiAgICAgICAgdHJ5IHtcbiAgICAgICAgICAgIGNvbnN0IHByZVN0YXRlID0gd3guZ2V0U3RvcmFnZVN5bmMoYEN1cnJlbnRTdGF0ZWApIHx8IHt9XG4gICAgICAgICAgICBjb25zdCB0aXRsZSA9IGBTdGF0ZSBDaGFuZ2VkYFxuICAgICAgICAgICAgY29uc29sZS5ncm91cENvbGxhcHNlZChgJWMgICR7IHRpdGxlIH0gJWMgJHsgT2JqZWN0LmtleXMoZGlmZlJlc3VsdCkgfWAsICdjb2xvcjojZTBjMTg0OyBmb250LXdlaWdodDogYm9sZCcsICdjb2xvcjojZjBhMTM5OyBmb250LXdlaWdodDogYm9sZCcpXG4gICAgICAgICAgICBjb25zb2xlLmxvZyhgJWMgICAgUHJlIFN0YXRlYCwgJ2NvbG9yOiNmZjY1YWY7IGZvbnQtd2VpZ2h0OiBib2xkJywgcHJlU3RhdGUpXG4gICAgICAgICAgICBjb25zb2xlLmxvZyhgJWMgQ2hhbmdlIFN0YXRlYCwgJ2NvbG9yOiMzZDkxY2Y7IGZvbnQtd2VpZ2h0OiBib2xkJywgZGlmZlJlc3VsdClcbiAgICAgICAgICAgIGNvbnNvbGUubG9nKGAlYyAgIE5leHQgU3RhdGVgLCAnY29sb3I6IzJjOWY2NzsgZm9udC13ZWlnaHQ6IGJvbGQnLCBzdG9yZS5kYXRhKVxuICAgICAgICAgICAgY29uc29sZS5ncm91cEVuZCgpXG4gICAgICAgICAgICB3eC5zZXRTdG9yYWdlU3luYyhgQ3VycmVudFN0YXRlYCwgc3RvcmUuZGF0YSlcbiAgICAgICAgfSBjYXRjaCAoZSkge1xuICAgICAgICAgICAgY29uc29sZS5sb2coZSlcbiAgICAgICAgfVxuICAgIH1cbn1cblxuZnVuY3Rpb24gdXBkYXRlU3RvcmVCeUZuUHJvcChlbGUsIGRhdGEpIHtcbiAgaWYoZGF0YSl7XG4gICAgbGV0IHBhdGNoID0ge31cbiAgICBmb3IgKGxldCBrZXkgaW4gZGF0YS5fX2ZuTWFwcGluZykge1xuICAgICAgcGF0Y2hba2V5XSA9IGRhdGEuX19mbk1hcHBpbmdba2V5XS5jYWxsKGRhdGEpXG4gICAgfVxuICAgIGVsZS5zZXREYXRhKHBhdGNoKVxuICB9XG59XG5cblxuXG5mdW5jdGlvbiBnZXRPYmpCeVBhdGgocGF0aCwgZGF0YSkge1xuICBjb25zdCBhcnIgPSBwYXRoLnJlcGxhY2UoL10vZywgJycpLnJlcGxhY2UoL1xcWy9nLCAnLicpLnNwbGl0KCcuJylcbiAgY29uc3QgbGVuID0gYXJyLmxlbmd0aFxuICBpZiAobGVuID4gMSkge1xuICAgIGxldCBjdXJyZW50ID0gZGF0YVthcnJbMF1dXG4gICAgZm9yIChsZXQgaSA9IDE7IGkgPCBsZW4gLSAxOyBpKyspIHtcbiAgICAgIGN1cnJlbnQgPSBjdXJyZW50W2FycltpXV1cbiAgICB9XG4gICAgcmV0dXJuIHsgb2JqOiBjdXJyZW50LCBrZXk6IGFycltsZW4gLSAxXSB9XG4gIH0gZWxzZSB7XG4gICAgcmV0dXJuIHsgb2JqOiBkYXRhLCBrZXk6IGFyclswXSB9XG4gIH1cbn1cblxuZnVuY3Rpb24gd2FsayhkYXRhKSB7XG4gIC8vX19fd2Fsa2VkIOeUqOS6juagh+iusOaYr+WQpuW3sue7j+inguWvn+mBjeWOhuS6hlxuICBkYXRhLl9fX3dhbGtlZCA9IHRydWVcbiAgT2JqZWN0LmtleXMoZGF0YSkuZm9yRWFjaChrZXkgPT4ge1xuICAgIGNvbnN0IG9iaiA9IGRhdGFba2V5XVxuICAgIGNvbnN0IHRwID0gdHlwZShvYmopXG4gICAgaWYgKHRwID09IEZVTkNUSU9OVFlQRSkge1xuICAgICAgc2V0UHJvcChrZXksIG9iaiwgZGF0YSlcbiAgICB9IGVsc2UgaWYgKHRwID09IE9CSkVDVFRZUEUpIHtcbiAgICAgIE9iamVjdC5rZXlzKG9iaikuZm9yRWFjaChzdWJLZXkgPT4ge1xuICAgICAgICBfd2FsayhvYmpbc3ViS2V5XSwga2V5ICsgJy4nICsgc3ViS2V5LCBkYXRhKVxuICAgICAgfSlcblxuICAgIH0gZWxzZSBpZiAodHAgPT0gQVJSQVlUWVBFKSB7XG4gICAgICBvYmouZm9yRWFjaCgoaXRlbSwgaW5kZXgpID0+IHtcbiAgICAgICAgX3dhbGsoaXRlbSwga2V5ICsgJ1snICsgaW5kZXggKyAnXScsIGRhdGEpXG4gICAgICB9KVxuXG4gICAgfVxuICB9KVxufVxuXG5mdW5jdGlvbiBfd2FsayhvYmosIHBhdGgsIGRhdGEpIHtcbiAgY29uc3QgdHAgPSB0eXBlKG9iailcbiAgaWYgKHRwID09IEZVTkNUSU9OVFlQRSkge1xuICAgIHNldFByb3AocGF0aCwgb2JqLCBkYXRhKVxuICB9IGVsc2UgaWYgKHRwID09IE9CSkVDVFRZUEUpIHtcbiAgICBPYmplY3Qua2V5cyhvYmopLmZvckVhY2goc3ViS2V5ID0+IHtcbiAgICAgIF93YWxrKG9ialtzdWJLZXldLCBwYXRoICsgJy4nICsgc3ViS2V5LCBkYXRhKVxuICAgIH0pXG5cbiAgfSBlbHNlIGlmICh0cCA9PSBBUlJBWVRZUEUpIHtcbiAgICBvYmouZm9yRWFjaCgoaXRlbSwgaW5kZXgpID0+IHtcbiAgICAgIF93YWxrKGl0ZW0sIHBhdGggKyAnWycgKyBpbmRleCArICddJywgZGF0YSlcbiAgICB9KVxuXG4gIH1cbn1cblxuZnVuY3Rpb24gc2V0UHJvcChwYXRoLCBmbiwgZGF0YSkge1xuICBjb25zdCBvayA9IGdldE9iakJ5UGF0aChwYXRoLCBkYXRhKVxuXG4gIGRhdGEuX19mbk1hcHBpbmcgPSBkYXRhLl9fZm5NYXBwaW5nIHx8IHt9XG4gIGRhdGEuX19mbk1hcHBpbmdbcGF0aF0gPSBmblxuICBPYmplY3QuZGVmaW5lUHJvcGVydHkob2sub2JqLCBvay5rZXksIHtcbiAgICBlbnVtZXJhYmxlOiB0cnVlLFxuICAgIGdldDogKCkgPT4ge1xuICAgICAgcmV0dXJuIGZuLmNhbGwob2sub2JqKVxuICAgIH0sXG4gICAgc2V0OiAoKSA9PiB7XG4gICAgICBjb25zb2xlLndhcm4oJ1BsZWFzZSB1c2luZyB0aGlzLmRhdGEubWV0aG9kIHRvIHNldCBtZXRob2QgcHJvcCBvZiBkYXRhIScpXG4gICAgfVxuICB9KVxuICBcblxufVxuXG5mdW5jdGlvbiB0eXBlKG9iaikge1xuICByZXR1cm4gT2JqZWN0LnByb3RvdHlwZS50b1N0cmluZy5jYWxsKG9iailcbn1cblxuXG5cblxuXG5cblxuZnVuY3Rpb24gdXBkYXRlQnlGblByb3AoZWxlLCBkYXRhKSB7XG4gIGxldCBwYXRjaCA9IHt9XG4gIGZvciAobGV0IGtleSBpbiBkYXRhLl9fZm5NYXBwaW5nKSB7XG4gICAgcGF0Y2hba2V5XSA9IGRhdGEuX19mbk1hcHBpbmdba2V5XS5jYWxsKGVsZS5vRGF0YSlcbiAgfVxuICBlbGUuc2V0RGF0YShwYXRjaClcbn1cblxuXG5jcmVhdGUub2JhYSA9IG9iYWFcblxuXG5leHBvcnQgZGVmYXVsdCBjcmVhdGVcbiJdfQ==